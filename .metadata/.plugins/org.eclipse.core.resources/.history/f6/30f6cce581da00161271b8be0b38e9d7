package exit.services.json;

import java.io.IOException;
import java.util.HashMap;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;

import exit.services.fileHandler.CSVHandler;
import exit.services.procesadorJson.IProcesadorJson;
import exit.services.procesadorJson.JsonProcesarReemplazo;
import exit.services.singletons.RecuperadorFormato;
import exit.services.singletons.RecuperadorPropierdadesJson;

public abstract class AbstractJsonRestEstructura {
	protected String line;
	protected String dataJson;
	protected JSONObject jsonFormato;
	protected HashMap<String, String> mapCabeceraValor;

	abstract public void agregarCampo(String cabecera, String valor);
	abstract public boolean validarCampos();
	abstract public JSONHandler createJson() throws Exception;
	abstract protected String alterarValor(String cabecera, String valor);
	

	
	public AbstractJsonRestEstructura() throws IOException {
		super();
		this.dataJson=RecuperadorFormato.getInstancia().getFormato();
		this.jsonFormato=RecuperadorFormato.getInstancia().getJsonFormato();
		mapCabeceraValor= new HashMap<String, String>();
	}
	
	public HashMap<String, String> getMapCabeceraValor(){
		return mapCabeceraValor;
	}
	
	protected void insertarValorMap(String cabecera, String valor){
		getMapCabeceraValor().put(cabecera, alterarValor(cabecera,valor));
	} 
	
	protected void insertarValorJson(String cabecera, String valor){ 
			//this.dataJson=this.dataJson.replaceAll("#"+cabecera+"#", alterarValor(cabecera,valor));
		JsonProcesarReemplazo jpr= new JsonProcesarReemplazo(alterarValor(cabecera,valor),cabecera);
		recorrerJSON(this.jsonFormato,jpr);
	}
	
	protected void recorrerJSON(JSONObject jsonObj, IProcesadorJson procesadorJson ) {
	    for (Object key : jsonObj.keySet()) {
	        String keyStr = (String)key;
	        Object keyvalue = jsonObj.get(keyStr);
	        if (keyvalue instanceof JSONObject)
	        	recorrerJSON((JSONObject)keyvalue,procesadorJson);
	        else if(keyvalue instanceof JSONArray)
	        	recorrerJSON((JSONArray)keyvalue,procesadorJson);
	        else
	        	procesadorJson.procesarJson(jsonObj, keyStr);
	        }
	}
	
	protected void recorrerJSON(JSONArray jsonArr, IProcesadorJson procesadorJson ){
		for(int i=0;i<jsonArr.size();i++){
			Object value=jsonArr.get(i);
	        if (value instanceof JSONObject)
	        	recorrerJSON((JSONObject)value,procesadorJson);
	        else if(value instanceof JSONArray)
	        	recorrerJSON((JSONArray)value,procesadorJson);
		    else
	        	procesadorJson.procesarJson(jsonArr, i);
		}
	}
	
	protected Boolean insertarTrueOFalse(String valor){
		if(valor == null)
			return null;
		if (valor.equalsIgnoreCase("si") || valor.equalsIgnoreCase("true") || valor.equalsIgnoreCase("verdadero"))
			return true;
		else if(valor.equalsIgnoreCase("no") || valor.equalsIgnoreCase("false") || valor.equalsIgnoreCase("false"))
			return false;
		else 
			return null;
	}
	

	protected String insertarFecha(String valor){
		final String PATH_ERROR="error_formato_fecha.csv";
		if(valor==null || valor.length()==0)
			return null;
		CSVHandler csv= new CSVHandler();
		String[] fecha=valor.split("/");
		if(fecha.length==3){
			try{
				return fecha[2]+"-"+fecha[0]+"-"+fecha[1];
			}
			catch(Exception e){
				try {
					csv.escribirCSV(PATH_ERROR, this.getLine());
				} catch (IOException e1) {
					e1.printStackTrace();
				}
				return null;
			}
		}
		fecha=valor.split("-");
		if(fecha.length!=3)
			return null;
		else
			return valor;

	}
	protected String insertarString(String valor){
		
		if(valor == null || valor.length()==0)
			return null;
		return valor;
	}
	
	protected String procesarFecha(String cabecera, String valor){
		return "\""+insertarFecha(valor)+"\"";
	}
	
	protected String procesarCadena(String cabecera, String valor){
		if(valor==null || valor.length()==0)
			return "null";
		return valor;
	}
	
	protected String procesarEntero(String cabecera, String valor){
		if(RecuperadorPropierdadesJson.getInstancia().isBorrarCarNoNumericos(cabecera))
			return valor.replaceAll("[^0-9]", "");
		return valor;
	}
	
	
	public String getLine(){
		return line;
	}
	public void setLine(String line){
		this.line=line;
	}
	
	public String getDataJson(){
		return dataJson;
	}
	public JSONObject getJsonFormato() {
		return jsonFormato;
	}
	
	
	
	
}
