package exit.services.fileHandler;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.ArrayList;

import org.json.simple.JSONArray;

import com.csvreader.CsvWriter;

import exit.services.json.JSONHandler;
import exit.services.json.JsonRestIncidentes;
import exit.services.parser.ParserXMLWSConnector;
import exit.services.principal.Separadores;

public class CSVHandler {
	
	public static String cabeceraFichero;
	public static final String PATH_ERROR_SERVER_NO_ALCANZADO="servidor_no_alcanzado.csv";
	public static final String PATH_SAC_EXISTENTE="sac_existente_services.csv";
	public static final String LOG_ERROR_FETCH_TIPO_INCIDENTE="error_fetch_tipo_incidente.txt";
	public static final String PATH_ERROR_EXCEPTION="exception_ejecucion.csv";
	public static final String PATH_ID_NO_ENCONTRADO="id_no_encontrado.csv";
	public static final String PATH_ERROR_EXCEPTION_LOG="exception_ejecucion_log.txt";
	public static final String NRO_SAC_REPETIDO_EN_EL_CSV_EJECUTADO="nro_sac_repetido_en_el_csv_ejecutado.csv";
	public static final String PATH_INSERTADOS_OK="insertadosOK.csv";
	

		private synchronized void crearCabecer(File file,String cabecera)  throws IOException{
            if(!file.exists() || file.length() == 0){
            		CsvWriter csvOutput = new CsvWriter(new FileWriter(file, true), ParserXMLWSConnector.getInstance().getSeparadorCSV().charAt(0));
    				csvOutput.write(cabecera);
    	        	csvOutput.endRecord();
    	            csvOutput.close();

    		}
		}
		
		private void escribirCampos(File file, String line){
            String[] campos= line.split(ParserXMLWSConnector.getInstance().getSeparadorCSVREGEX());
            for(String c:campos){
                csvOutput.write(c);        
            }
            csvOutput.endRecord();		 
            csvOutput.close();
		}
		
		private synchronized void crearCabecer(File file)  throws IOException{
			crearCabecer(file,cabeceraFichero);
		}	
		
		 public void escribirCSV(File file,String line, boolean tieneCabeceraDefault,String cabecera) throws IOException{
			 	CsvWriter csvOutput = new CsvWriter(new FileWriter(file, true), ParserXMLWSConnector.getInstance().getSeparadorCSV().charAt(0));
	            if(tieneCabeceraDefault)
	            	crearCabecer(file,cabecera);

		 }
		 
		
		 public void escribirCSV(File file,String line, boolean tieneCabeceraDefault) throws IOException{
			 if(tieneCabeceraDefault)
				 escribirCSV(file,line,tieneCabeceraDefault,cabeceraFichero);
		 }
		 
		 public void escribirCSV(File file,String line) throws IOException{
			 escribirCSV(file,line,true);
		 }
		 
		 public void escribirCSV(String path,String line) throws IOException{
			 	escribirCSV(DirectorioManager.getDirectorioFechaYHoraInicio(path),line);
		 }
		 public void escribirCSV(String path,String line,boolean cabeceraDefecto) throws IOException{
			 	escribirCSV(DirectorioManager.getDirectorioFechaYHoraInicio(path),line,cabeceraDefecto);
		 }
		 public void escribirCSV(String path,JSONHandler json) throws IOException{
			 escribirCSV(DirectorioManager.getDirectorioFechaYHoraInicio(path),json.getLine(),true);
		 }
		 
		 private void insertarCampoVacio(CsvWriter csvOutput) throws IOException{
        	 csvOutput.write(insertarNoNull(""));
		 }
		 
		 private String insertarNoNull(String cadena){
			 if(cadena!=null)
				 return cadena;
			 return "";
		 }
		 
		 public synchronized void escribirErrorException(StackTraceElement[] stackArray) {
			 escribirErrorException(null,stackArray);
		 }
		 
		 public synchronized void escribirErrorException(JSONHandler json,StackTraceElement[] stackArray) {
			  	File fichero = new File(ParserXMLWSConnector.getInstance().getFicheroError()); 
			     PrintWriter out;
					try {
						if(json!=null){
							this.escribirCSV(PATH_ERROR_EXCEPTION,json.getLine());
							this.escribirCSV(PATH_ERROR_EXCEPTION_LOG,json.getLine());
						}
						for(StackTraceElement ste: stackArray){
						     this.escribirCSV(PATH_ERROR_EXCEPTION_LOG,"FileName: "+ste.getFileName()+" Metodo: "+ste.getMethodName()+"Clase "+ste.getClassName()+" Linea "+ste.getLineNumber(),false);
						}		
						this.escribirCSV(PATH_ERROR_EXCEPTION_LOG,Separadores.SEPARADOR_ERROR_TRYCATCH);
						} catch (IOException e) {
						e.printStackTrace();
					}
		 }
}
